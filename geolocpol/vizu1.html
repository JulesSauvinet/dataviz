<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Loading data from server</title>
        <script type="text/javascript" src= "js/lib/d3.js"></script>

        <style>
	        body {font-family: monospace; line-height: 160%; font-size: 18px; }
	        ul {list-style: none; margin: 0; padding: 0;}
	        li {display: inline-block; width: 40px; padding: 10px; background-color: #eee; margin: 0;}
        </style>

    </head>
    <body>

    <script>
    
    var width = 900;
    var height = 450;

    //var list = d3.select("body").append("ul");

    var svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height)

    var data = [];
    var years = [];
    var pollutants = [];
    var countries = [];

    var yearsValue = [];


	var marginBottom = 50;
	var marginTop = 50;		
	var gap = 10;

   	var maxPolValue = 0.0;

	var yearsValueForm = [];


    d3.csv("data/air_emissions_1990_2014.csv",
        function(datas) {
	          datas.forEach(function(d) {
			     var pollutant = d["Pollutant"]; 
	        	 var year = d["YEA"]; 
	        	 var country = d["Country"]; 
	        	 if (!data[year])
	        	 	data[year]=[];

	        	 if (!data[year][country])
	        	 	data[year][country]={};

	        	 if (!data[year][country][pollutant])
	        	 	data[year][country][pollutant]={};

	        	 data[year][country][pollutant]=d;

	        	 if (!years.includes(year)){
	        	 	years.push(year);
	        	 }
	         	 if (!countries.includes(country)){
	        	 	countries.push(country);
	        	 }
	         	 if (!pollutants.includes(pollutant)){
	        	 	pollutants.push(pollutant);
	        	 }

	        	 if (!yearsValue[year]){
	        	 	yearsValue[year] = parseInt(d["Value"]);
	        	 }
	         	 else {
	        	 	yearsValue[year] += parseInt(d["Value"]);
	        	 }
			  });

		     function drawChart(){

	   		   var nbyears = years.length;
			   var stepWidthYear = (width-40)/(nbyears+2);

			    for (var y in yearsValue) {
				  if (yearsValue[y]>maxPolValue){
				  		maxPolValue = yearsValue[y];
				  }
				}

			    for (var y in yearsValue) {
					yearsValueForm.push({year: y, value:yearsValue[y]})  
				}

			    var selection1 = svg.selectAll("text").data(years);

			    selection1.enter().append("text")
			      .text(function(d){ return d;})
			      .attr("y", function (d) { return height-marginBottom;})
			      .attr("x", function(d,i){return 4*gap + i*stepWidthYear;})
			      .style("font-size", function(d,i){return 8;})
			      .style("font-family", "helvetica");

			    var maxHeightRect = (height-marginBottom-marginTop-gap)/maxPolValue;
				var colors = d3.scale.category20();

                var selection2 = svg.selectAll("rect").data(yearsValueForm);

	    	    selection2.enter().append("rect")
			      .attr("y", function(d) { return height-marginBottom-2*gap-d["value"]*maxHeightRect ;})
			      .attr("x", function(d, i) { return 4*gap + i*stepWidthYear;})
	              .attr("width", stepWidthYear/2)
	              .attr("height",function(d,i){return d["value"]*maxHeightRect;})
	              .attr("fill", function(d, i) { return "#d1c9b8" /*colors(i)*/; })
	              .style( "opacity", 0.5 )

	  		    svg.append("text")
			      .text("Pollutant emission around the world")
			      .attr("y", 40)
			      .attr("x", width/2-150)
	  		      .style("font-size", 16)
			      .style("font-family", "helvetica")
			      .style("font-weight", "bold");

			     // remove any unused bars
			    selection1.exit()
			      .remove();
			    selection2.exit()
			      .remove();
			}

			drawChart();

         /*list.selectAll("ul")
         .data(data)
         .enter()
         .append("li")
         .text(function(d) { return d.petalLength; })*/
    	 
    	});

    </script>

    </body>
</html>

<!-- 
LES CHAMPS :
COU
Country
Flag Codes
Flags
POL
Pollutant
PowerCode
PowerCode Code 
Reference Period
Reference Period Code
Unit 
Unit Code
VAR
Value
Variable
YEA
Year

TODO faire en fonction des polluants
 -->